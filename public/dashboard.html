<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Furry Tails Meycauayan</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="modal.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <div class="sidebar">
        <h1>Admin</h1>
        <p class="welcome-text">Welcome, admin</p>

        <nav>
          <a href="dashboard.html" class="active">Dashboard</a>
          <a href="users.html">Users</a>
          <a href="pets.html">Pets</a>
          <a href="bookings.html">Pending Bookings</a>
          <a href="bookings-approved.html">Bookings</a>

          <!-- Reports Sub-menu -->
          <div class="nav-item">
            <a href="#" class="nav-link" id="reportsDropdown">Reports ▼</a>
            <div class="submenu" id="reportsSubmenu">
              <a href="booking-reports.html">Booking Reports</a>
              <a href="feeding-reports.html">Feeding Reports</a>
              <a href="sales-reports.html">Sales Reports</a>
            </div>
          </div>
        </nav>

        <a href="#" class="logout" id="logoutButton">Logout</a>
      </div>

      <div class="main-content">
        <h1>Dashboard</h1>

        <div class="stats-grid">
          <div class="stat-card stat-users" id="usersCard">
            <img src="image/icon-users.png" alt="Users" class="stat-icon" />
            <h3>Users</h3>
            <div class="stat-number" id="userCount">0</div>
          </div>

          <div class="stat-card stat-pending" id="pendingBookingsCard">
            <img
              src="image/icon-pending-bookings.png"
              alt="Pending Bookings"
              class="stat-icon"
            />
            <h3>Pending Bookings</h3>
            <div class="stat-number" id="pendingBookingsCount">0</div>
          </div>

          <div class="stat-card stat-feeding" id="feedingReportsCard">
            <img
              src="image/icon-feeding-reports.png"
              alt="Feeding Reports"
              class="stat-icon"
            />
            <h3>Feeding Reports</h3>
            <div class="stat-number" id="feedingReportsCount">0</div>
          </div>

          <div class="stat-card stat-pets" id="petsCard">
            <img src="image/icon-pets.png" alt="Pets" class="stat-icon" />
            <h3>Pets</h3>
            <div class="stat-number" id="petsCount">0</div>
          </div>

          <div class="stat-card stat-booked" id="totalBookedCard">
            <img
              src="image/icon-total-booked.png"
              alt="Total Booked"
              class="stat-icon"
            />
            <h3>Total Booked</h3>
            <div class="stat-number" id="totalBookedCount">0</div>
          </div>
          <div class="stat-card stat-weekly-sales" id="weeklySalesCard">
            <img src="image/icon-sales.png" alt="Logo" class="stat-icon" />
            <h3>Sales (This Week)</h3>
            <div class="stat-number" id="weeklySalesAmount">₱0</div>
          </div>
        </div>

        <!-- Sales Forecasting Graph Section -->
        <div class="dashboard-graph-section" style="margin: 32px 0">
          <div class="forecast-controls" style="margin-bottom: 20px">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 20px;
                flex-wrap: wrap;
              "
            >
              <div style="display: flex; align-items: center; gap: 8px">
                <label
                  for="forecastPeriod"
                  style="font-weight: 500; color: #333"
                  >Forecast Period:</label
                >
                <select
                  id="forecastPeriod"
                  style="
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    background: white;
                  "
                >
                  <option value="week">Next Week</option>
                  <option value="month">Next Month</option>
                  <option value="quarter">Next Quarter</option>
                  <option value="year">Next Year</option>
                  <option value="holiday">Holiday Season</option>
                </select>
              </div>

              <div style="display: flex; align-items: center; gap: 8px">
                <label for="forecastModel" style="font-weight: 500; color: #333"
                  >Model:</label
                >
                <select
                  id="forecastModel"
                  style="
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    background: white;
                  "
                >
                  <option value="trend">Trend Analysis</option>
                  <option value="seasonal">Seasonal</option>
                  <option value="holiday">Holiday-Adjusted</option>
                  <option value="hybrid" selected>Hybrid</option>
                </select>
              </div>

              <div style="display: flex; align-items: center; gap: 8px">
                <label for="chartType" style="font-weight: 500; color: #333"
                  >Chart:</label
                >
                <select
                  id="chartType"
                  style="
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    background: white;
                  "
                >
                  <option value="line" selected>Line</option>
                  <option value="bar">Bar</option>
                </select>
              </div>

              <button
                id="generateForecastBtn"
                style="
                  background: linear-gradient(135deg, #44dce7 0%);
                  color: rgb(255, 255, 255);
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 500;
                  transition: transform 0.2s;
                "
              >
                Generate Forecast
              </button>
            </div>
          </div>

          <h2>Sales Forecasting & Trend Analysis</h2>
          <div
            class="forecast-summary"
            id="forecastSummary"
            style="display: none; margin-bottom: 20px"
          >
            <div
              class="forecast-card"
              style="
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #667eea;
                text-align: center;
              "
            >
              <h3 style="margin: 0 0 10px 0; color: #333; font-size: 1em">
                Predicted Revenue
              </h3>
              <div
                class="amount"
                id="predictedRevenue"
                style="
                  font-size: 1.5em;
                  font-weight: bold;
                  color: #667eea;
                  margin: 10px 0;
                "
              >
                ₱0
              </div>
            </div>
            <div
              class="forecast-card"
              style="
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #4caf50;
                text-align: center;
              "
            >
              <h3 style="margin: 0 0 10px 0; color: #333; font-size: 1em">
                Growth Rate
              </h3>
              <div
                class="amount"
                id="growthRate"
                style="
                  font-size: 1.5em;
                  font-weight: bold;
                  color: #4caf50;
                  margin: 10px 0;
                "
              >
                0%
              </div>
            </div>
            <div
              class="forecast-card"
              style="
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #ff9800;
                text-align: center;
              "
            >
              <h3 style="margin: 0 0 10px 0; color: #333; font-size: 1em">
                Confidence
              </h3>
              <div
                class="amount"
                id="confidenceLevel"
                style="
                  font-size: 1.5em;
                  font-weight: bold;
                  color: #ff9800;
                  margin: 10px 0;
                "
              >
                0%
              </div>
            </div>
          </div>

          <canvas
            id="salesForecastGraph"
            class="dashboard-graph-canvas"
          ></canvas>
        </div>
      </div>

      <!-- TRY LANG PO -->
    </div>

    <!-- Modal for today's bookings notification -->
    <div id="viewDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalHeader">Today's Bookings</h2>
          <button id="modalCloseBtn" class="close-button">&times;</button>
        </div>
        <div class="modal-body" id="bookingDetailsContent">
          <!-- Content will be loaded here by JavaScript -->
        </div>
        <div class="modal-footer">
          <button id="modalCloseBtnFooter" class="btn btn-secondary">
            Close
          </button>
        </div>
      </div>
    </div>
    <div id="overlay" class="overlay"></div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="./js/firebase-config.js"></script>
    <script type="module" src="./js/auth.js"></script>
    <script type="module" src="./js/dashboard.js"></script>
    <script>
      // Sales Forecasting Graph
      let salesForecastChart;
      let currentForecastData = {};

      // Initialize the chart
      const initSalesForecastChart = () => {
        const ctx = document
          .getElementById("salesForecastGraph")
          .getContext("2d");

        salesForecastChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Historical Sales",
                data: [],
                borderColor: "rgba(59, 130, 246, 1)",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
              },
              {
                label: "Forecasted Sales",
                data: [],
                borderColor: "rgba(34, 197, 94, 1)",
                backgroundColor: "rgba(34, 197, 94, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                borderDash: [5, 5],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  color: "#000",
                  font: { weight: "bold" },
                },
              },
              title: {
                display: false,
              },
              tooltip: {
                bodyColor: "#000",
                titleColor: "#000",
                backgroundColor: "#fff",
                borderColor: "#e5e7eb",
                borderWidth: 1,
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": ₱" +
                      context.parsed.y.toLocaleString()
                    );
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1000,
                  color: "#000",
                  font: { weight: "bold" },
                  callback: function (value) {
                    return "₱" + value.toLocaleString();
                  },
                },
                title: {
                  display: true,
                  text: "Revenue (₱)",
                  color: "#000",
                  font: { weight: "bold" },
                },
              },
              x: {
                ticks: {
                  color: "#000",
                  font: { weight: "bold" },
                },
                title: {
                  display: true,
                  text: "Time Period",
                  color: "#000",
                  font: { weight: "bold" },
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
          },
        });
      };
      const updateChartType = (type) => {
        if (!salesForecastChart) return;
        const historical = salesForecastChart.data.datasets[0];
        const forecasted = salesForecastChart.data.datasets[1];
        if (type === "bar") {
          historical.type = "bar";
          forecasted.type = "bar";
          historical.backgroundColor = "rgba(59, 130, 246, 0.6)";
          forecasted.backgroundColor = "rgba(34, 197, 94, 0.6)";
          historical.borderWidth = 0;
          forecasted.borderWidth = 0;
          forecasted.borderDash = [];
          historical.fill = false;
          forecasted.fill = false;
        } else {
          historical.type = "line";
          forecasted.type = "line";
          historical.borderColor = "rgba(59, 130, 246, 1)";
          historical.backgroundColor = "rgba(59, 130, 246, 0.1)";
          forecasted.borderColor = "rgba(34, 197, 94, 1)";
          forecasted.backgroundColor = "rgba(34, 197, 94, 0.1)";
          historical.borderWidth = 3;
          forecasted.borderWidth = 3;
          forecasted.borderDash = [5, 5];
          historical.fill = true;
          forecasted.fill = true;
        }
        salesForecastChart.update();
      };

      // Generate forecast data based on period and model
      const generateForecast = (period, model) => {
        const now = new Date();
        let labels = [];
        let historicalData = [];
        let forecastData = [];

        // Generate historical data (last 6 periods)
        for (let i = 5; i >= 0; i--) {
          let date;
          let label;

          switch (period) {
            case "week":
              date = new Date(now.getTime() - i * 7 * 24 * 60 * 60 * 1000);
              // FIXED: Changed to a more user-friendly date format
              label = date.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              });
              historicalData.push(Math.floor(Math.random() * 5000) + 3000);
              break;
            case "month":
              date = new Date(now.getFullYear(), now.getMonth() - i, 1);
              label = date.toLocaleDateString("en-US", {
                month: "short",
                year: "numeric",
              });
              historicalData.push(Math.floor(Math.random() * 20000) + 15000);
              break;
            case "quarter":
              const quarter = Math.floor((now.getMonth() - i * 3) / 3);
              const year = now.getFullYear() - Math.floor((i * 3) / 12);
              label = `Q${quarter + 1} ${year}`;
              historicalData.push(Math.floor(Math.random() * 60000) + 45000);
              break;
            case "year":
              const yearVal = now.getFullYear() - i;
              label = yearVal.toString();
              historicalData.push(Math.floor(Math.random() * 200000) + 150000);
              break;
            case "holiday":
              const holidayMonths = ["Dec", "Jan", "Feb", "Mar", "Apr", "May"];
              label = holidayMonths[i];
              historicalData.push(Math.floor(Math.random() * 30000) + 25000);
              break;
          }
          labels.push(label);
        }

        // Generate forecast data (next 3 periods)
        for (let i = 1; i <= 3; i++) {
          let label;
          let forecast;

          switch (period) {
            case "week":
              const nextWeek = new Date(
                now.getTime() + i * 7 * 24 * 60 * 60 * 1000
              );
              // FIXED: Changed to a more user-friendly date format
              label = nextWeek.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
              });
              break;
            case "month":
              const nextMonth = new Date(
                now.getFullYear(),
                now.getMonth() + i,
                1
              );
              label = nextMonth.toLocaleDateString("en-US", {
                month: "short",
                year: "numeric",
              });
              break;
            case "quarter":
              const nextQuarter = Math.floor((now.getMonth() + i * 3) / 3);
              const nextYear =
                now.getFullYear() + Math.floor((now.getMonth() + i * 3) / 12);
              label = `Q${nextQuarter + 1} ${nextYear}`;
              break;
            case "year":
              label = (now.getFullYear() + i).toString();
              break;
            case "holiday":
              const nextHolidayMonths = ["Jun", "Jul", "Aug"];
              label = nextHolidayMonths[i - 1];
              break;
          }

          // Apply forecasting model
          const lastValue = historicalData[historicalData.length - 1];
          let growthFactor = 1;

          switch (model) {
            case "trend":
              growthFactor = 1 + (Math.random() * 0.2 - 0.05); // -5% to +15%
              break;
            case "seasonal":
              growthFactor = 1 + (Math.random() * 0.3 - 0.1); // -10% to +20%
              break;
            case "holiday":
              growthFactor = 1 + (Math.random() * 0.4 - 0.05); // -5% to +35%
              break;
            case "hybrid":
              growthFactor = 1 + (Math.random() * 0.25 - 0.05); // -5% to +20%
              break;
          }

          forecast = Math.floor(lastValue * growthFactor);
          forecastData.push(forecast);
          labels.push(label);
        }

        return { labels, historicalData, forecastData };
      };

      // Update forecast summary
      const updateForecastSummary = (historicalData, forecastData) => {
        const lastHistorical = historicalData[historicalData.length - 1];
        const firstForecast = forecastData[0];
        const growthRate = (
          ((firstForecast - lastHistorical) / lastHistorical) *
          100
        ).toFixed(1);
        const confidence = Math.floor(Math.random() * 20) + 80; // 80-100%

        document.getElementById("predictedRevenue").textContent =
          "₱" + firstForecast.toLocaleString();
        document.getElementById("growthRate").textContent = growthRate + "%";
        document.getElementById("confidenceLevel").textContent =
          confidence + "%";
        document.getElementById("forecastSummary").style.display = "grid";
      };

      // Handle forecast generation
      document
        .getElementById("generateForecastBtn")
        .addEventListener("click", function () {
          const period = document.getElementById("forecastPeriod").value;
          const model = document.getElementById("forecastModel").value;

          const forecastData = generateForecast(period, model);

          // Update chart
          salesForecastChart.data.labels = forecastData.labels;
          salesForecastChart.data.datasets[0].data = [
            ...forecastData.historicalData,
            ...new Array(3).fill(null),
          ];
          salesForecastChart.data.datasets[1].data = [
            ...new Array(6).fill(null),
            ...forecastData.forecastData,
          ];

          salesForecastChart.update();

          // Update summary
          updateForecastSummary(
            forecastData.historicalData,
            forecastData.forecastData
          );
        });

      // Initialize chart when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initSalesForecastChart();
        const chartTypeSelect = document.getElementById("chartType");
        if (chartTypeSelect) {
          updateChartType(chartTypeSelect.value);
          chartTypeSelect.addEventListener("change", function (e) {
            updateChartType(e.target.value);
          });
        }

        // Generate initial forecast
        setTimeout(() => {
          document.getElementById("generateForecastBtn").click();
        }, 500);
      });
    </script>

    <script>
      document.getElementById("usersCard").onclick = () =>
        (window.location.href = "users.html");
      document.getElementById("petsCard").onclick = () =>
        (window.location.href = "pets.html");
      document.getElementById("pendingBookingsCard").onclick = () =>
        (window.location.href = "bookings.html");
      document.getElementById("feedingReportsCard").onclick = () =>
        (window.location.href = "feeding-reports.html");
      const weeklySalesCard = document.getElementById("weeklySalesCard");
      if (weeklySalesCard) {
        weeklySalesCard.onclick = () =>
          (window.location.href = "sales-reports.html");
      }
    </script>

    <script type="module">
      import { initializeLogout } from "./js/logout-handler.js";
      import { checkAndShowTodayBookings } from "./js/daily-bookings-notification.js";
      // Removed real-time rejection monitoring
      import { initializeAcceptanceMonitoring } from "./js/realtime-acceptance-monitor.js";
      initializeLogout();
      
      // Check for today's bookings when dashboard loads
      document.addEventListener("DOMContentLoaded", async () => {
        // Wait a bit for the dashboard to fully load before showing notification
        setTimeout(async () => {
          await checkAndShowTodayBookings();
        }, 2000);
        
        // Removed rejection monitoring - no longer needed
        
        // Initialize acceptance monitoring for dashboard
        initializeAcceptanceMonitoring();
      });
    </script>

    <!-- Sub-menu Toggle Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const reportsDropdown = document.getElementById("reportsDropdown");
        const reportsSubmenu = document.getElementById("reportsSubmenu");

        // Only handle reports dropdown clicks
        reportsDropdown.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation(); // Prevent event bubbling
          reportsSubmenu.classList.toggle("active");

          // Change arrow direction
          if (reportsSubmenu.classList.contains("active")) {
            reportsDropdown.innerHTML = "Reports ▲";
          } else {
            reportsDropdown.innerHTML = "Reports ▼";
          }
        });

        // Close submenu when clicking outside the reports section specifically
        document.addEventListener("click", function (e) {
          // Only close if clicking outside the reports dropdown area
          if (
            !e.target.closest("#reportsDropdown") &&
            !e.target.closest("#reportsSubmenu")
          ) {
            reportsSubmenu.classList.remove("active");
            reportsDropdown.innerHTML = "Reports ▼";
          }
        });
      });
    </script>
    <style>
      body,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      label,
      span,
      div,
      a,
      th,
      td,
      input,
      select,
      button {
        color: #000 !important;
      }

      .dashboard-graph-canvas {
        display: block;
        max-width: 1000px;
        width: 100%;
        height: 500px;
        margin: 32px auto 0 auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        border: 1px solid #ececec;
        padding: 24px 16px 16px 16px;
      }

      .forecast-controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e9ecef;
      }

      .forecast-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .forecast-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .forecast-card h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1em;
      }

      .forecast-card .amount {
        font-size: 1.5em;
        font-weight: bold;
        margin: 10px 0;
      }

      #generateForecastBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
    </style>
  </body>
</html>
